---
title: "Week6_data_work_r"
date: "2023-02-08"
output:
      html_document
---

### Simulating counterfactual outcomes with 1 confounder variable   



We only need two libraries today 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
```


We will generate variables whose name follows the lecture material, specifically:    
  
  *A*: Binary exposure    
  *L*: Binary confounder   
  *Y*: Binary outcome (observed outcome)    

  
Note that the confounder variable is first generated, from which the exposure and the outcome are generated. Thus, the variable L is a common cause, rather than common effect (collider).  

#### Be sure to check to see if the positivity assumption is met in your data. 

```{r}
# Set see to get same results within the same computer 
set.seed(1)

# Set the number of people, this is sample size in your data
N = 500


# Create a binary confounder variable 
L=rbinom(N,1, 0.5)
table(L)


# Then binary exposure, partially based on the status of confounder 
A=runif(N, max=(1+L))
A <- ifelse(A > 0.4, 0, 1)
table(A)


# QUickly check the association of A and L
epitools::epitab(A, L, method = "oddsratio")$tab
table(A, L)
```


If there is no zero-cell across A and L, proceed to the next step, creating *Y*. 
```{r}
# Create a third variable (fake confounder) from the outcome and exposure  
theta = -1 + 0.3*A + -0.4*L  # Generate logit of outcome
prob <- 1/(1+exp(-theta))  # convert logit values into probabilities
Y= rbinom(N,1,prob) # Generate the binary values from the probabilities of the outcome

head(Y, 40) # display values 
```


We need to create a data frame with the three variables before running the model 
```{r}
myData <- data.frame(Y, A, L)
table(myData$Y)
table(myData$A)
table(myData$L)
```


As usual, check the association between Y and L, A and L.  
```{r}
epitools::epitab(myData$A, myData$Y, method = "oddsratio")$tab
epitools::epitab(myData$L, myData$Y, method = "oddsratio")$tab
```

##### Run the regression to capture the association between Y and A, and Y and L
```{r}
regressResult <- glm(data=myData, Y~L + A,  family="binomial")


# Show the results - logit scale 
coefficients(regressResult) %>%  round(2)
regressResult %>%  confint() %>% round(2)

# Show the results - odds ratio scale
coefficients(regressResult) %>%  exp %>% round(2)
regressResult %>%  confint()  %>% exp %>%  round(2)
```


We now set A=1 and A=0 to everyone in the data
```{r}
myData_allExposed <- myData %>% mutate(A=1) 
table(myData_allExposed$A)

myData_NotExposed <- myData %>% mutate(A=0) 
table(myData_NotExposed$A)
```

Generate marginal outcome and plot the distribution. Do you know why the histogram is so bimodal? 
```{r}
pred_Ya_1 <- predict(regressResult, newdata =myData_allExposed, type = "response")
hist(pred_Ya_1)
pred_Ya_0 <- predict(regressResult, newdata =myData_NotExposed, type = "response")
hist(pred_Ya_0)
```

Lets calculate marginal outcome, had everyone exposed and not exposed 
##### Be sure to know which measure corresponds to ATE, OR, and RR, and why the values differ. ALso check to see your analyssi correctly recovered the odds ratio you set during the data generation process. Report these values to combine with colleague's results. 
```{r}
mean(pred_Ya_1) / mean(pred_Ya_0) # no CI for this 
{mean(pred_Ya_1) / (1-mean(pred_Ya_1))} / {mean(pred_Ya_0)/(1-mean(pred_Ya_0))}
mean(pred_Ya_1) - mean(pred_Ya_0)



```
