---
title: "Assignment2_bias"
author: "HM"
date: "2023-01-14"
output:
      html_document:
        keep_md: true
---

## Objective of assignment 2 
To perform simple analysis for selection bias and information bias using the categorical variables you have already created (physical activity)  

We have 9 short questions (Question 1a-d and Question 2a-e) to answer at the bottom of this script. 

## A few important notes 
  * R is case sensitive, so variables like, `my_Variable` and `my_variable` are different. So if you type the former and later type the latter, there will me an error message: `Error: object 'my_variable' not found`
  * This file is located in https://github.com/walkabilly/chep801_usask/blob/main/Assignments/Bias/Assignment2---Bias.md. IN Rstudio, create new markdown file by selecting _file_ -> _new markdown_ (with Html output). Copy and paste R codes and run line by line to follow the steps. Alternatively, paste entire rmd https://github.com/walkabilly/chep801_usask/blob/main/Assignments/Bias/Assignment2%20-%20Bias.Rmd.     
  * Before running these codes, first install "episensr" and "htmlTable". Copy and paste `install.packages(c("htmlTable", "episensr"))`  If a popup window shows up to restart R, click `yes`. Once these packages are installed, remove this line to prevent re-installation. 


```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# load the episenr package after installation. This needs to be done every time you analyse
library("episensr") #you can quote or unquote, but need quote when using install.package, but not when using library, don't ask me why
library(htmlTable)

# packaged used in the data work lab and assignment 1, needed to run some functions in this assignment
library(tidyverse)
library("knitr")
library("epitools")

```



First, lets load the data. Make sure to specify your own path to the data. 
```{r, warning = FALSE}
data <- read_csv("Data.csv")
```


### Exclusion of some cases
Lets suppose this is a study of aging, so we limit the sample to participants with a bit older age of > 45 in this study. One way to do so is to run following lines:
```{r, warning = FALSE}
# quick descriptive analysis, count and proportion of each age (from age 30 - 74) in the original sample
prop.table(table(data$SDC_AGE_CALC))
table(data$SDC_AGE_CALC)

# we also show the distribution of age in histrogram 
hist(data$SDC_AGE_CALC, main = "Age distribution in my data")

# now, we create a new data called "d", which consists of those with age > 45
d <- data %>% filter(SDC_AGE_CALC > 45)

# lets check how many people are in the original and our subset data using a command to count number of rows
nrow(data)
nrow(d)
# a lot less people now...
```
We now remove the "data" table and use only subset "d" from now on
```{r}
rm(data)
```


### Exposure variable 
Here, I copied and pasted the scripts to create a categorical variable for physical activity from the last class and assignment. However, this time, the PA (Physical Activity) variable is dichotomous, rather than 3 levels, named as `pa_dic`. We will dichotomize into 1/0 numeric value, then convert to categorical using `factor` as in the previous class (without using factor, the variable will be treated as number rather than category). 

```{r}
d <- d %>%
    mutate(pa_dic = case_when(
      PA_TOTAL_SHORT < 600  ~ 1,
      PA_TOTAL_SHORT >= 600 ~ 0
    )
  )

# Make variable to dichotomous from integer variable of 1/0
d$pa_dic <- as.factor(d$pa_dic)

# Give label to the variable, 0: moderate/high and 1: low physical activity 
levels(d$pa_dic) <- c( "Moderate/high PA", "low PA")

#lets check mean activity levels across two categories of PA we just created 
d %>% group_by(pa_dic) %>% summarize(mean = mean(PA_TOTAL_SHORT))

```


### OUtcome variable
Lets create the outcome variable type 2 diabetes mellitus. 
Presumably this variable is self-reported by participants, so they are not as accurate as actual diagnostic report, but people normally do not lie for these chronic disease status so acceptable accuracy, I hope. 


*Definitions of diabetes variables in the data dictionary is as follows (double check with the Excel data dictionary file)*
  -   value 1  -	Diabetes mellitus type 1,  not our interest
  -   value 2  - 	Diabetes mellitus type 2,  our outcome if interest
  -   value 3	 - Gestational diabetes only,  not our interest
  -   value 4  -  -7	Not Applicable       , people without any diabetes


First, check the diabetes variable
```{r}
# check frequency of 4 types of diabates types 
table(d$DIS_DIAB_TYPE)

# there is also another value type - missing value coded as NA, see the first 10 people, 4th person did not report anything
head(d$DIS_DIAB_TYPE, n = 10) # showing first 10 entries 
summary(d$DIS_DIAB_TYPE) # See exact number of whose did not report (NA's)


# For simplicity, we will remove people who did not respond (in real research, if the proportion of people with missing data seems important , like 10% of all people, you need to perform imputation)

d %>% filter(is.na(DIS_DIAB_TYPE)) %>% nrow() # First, count # of people with missing diabetes record
d <- d %>% filter(!is.na(DIS_DIAB_TYPE)) # then, remove these people 

# I will also remove people with type 1 diabetes, as they occur very early age and patient usually have very different lifestyle and risk of chronic illness 
d <- d %>% filter(DIS_DIAB_TYPE != 1) 

```

Now lets create diabetes binary category variable. 
We create binary variable for type 2 diabetes, grouping gestational diabetes into the no diabetes category, and type 2 diabetes as the diabetes category. 
```{r}
table(d$DIS_DIAB_TYPE)

d <- d %>%
  mutate(diabetes_dic = case_when(
    DIS_DIAB_TYPE == -7 | DIS_DIAB_TYPE == -7 ~ 0,
    DIS_DIAB_TYPE ==  2 ~ 1
  ))

# we coded the new variable as numeric of 1 and 0. I will make it into categorical (called factor) with 2 levels. 
d$diabetes_dic <- as.factor(d$diabetes_dic)
levels(d$diabetes_dic) = c("noDiabetes", "diabetes") # THis means 0 and 1 category gets descriptive lables
table(d$diabetes_dic)

# compare the old (3 categories in number) and new variable (binary factor - categorical- variable with lebel) 
table(d$DIS_DIAB_TYPE, d$diabetes_dic)

```


### 2x2 table for risk ratio
We will now display relative risk of diabetes among people with varying level of physical activity using the `epitable` function as in the data lab last week. 
First , just show count using the `epitable` function (the option `rev="both"` just changes the order of categories. You can remove this option if you like and see what will happen to the table)
```{r}
# Make table
table_pa_dia <- epitable(d$pa_dic, d$diabetes_dic, rev = "both") 
# No need to know the command below, it just gives label called "exposure" to the table
names(attr(table_pa_dia, "dimnames"))[1] <- "Exposure"

# Now display table 
table_pa_dia
# Bit fancy way
library(htmlTable)
# bit more fancy way
htmlTable(table_pa_dia)
```
### Risk ratio (ralative risk)
In this table , incidence risk among exposed is      
 _*434/(434+4937)=0.081*_   
 
Incidence risk among unexposed is     
 _*1094/(1094+16263)=0.063*_   
 
Therefore, risk ratio (RR) is      
 _*0.081/0.063*_   

Now, calculate RR using `epitab` from the data lab week 2. 
Here, the exposure of interest is **Low PA** and the outcome is **Diabetes**. 
```{r}
#Create table and save 
table_rr_pa_dia <- epitab(table_pa_dia, method = "riskratio", rev = "both")
```

Exploring the table. 
Note that column `upper` and `lower` are upper and lower bound of confidence interval for the risk ratio. 
Unfortunately, the order of the column/row are _reversed_ because of some issues in this function (location of table cells, a b, c, d is flipped horizontally and vertically), so be careful when calculating associations manually from this table.
It is important to round numeric variables to appropriate number of digits. We will round to 2. 
```{r}
# Show table only, no other extra cluttering information 
table_rr_pa_dia$tab

round(table_rr_pa_dia$tab, 2)
```

We can also display only specific set of columns , which are specified by index specification accessed by `[]` from this table, like `table[row, column]`. In the example below, I am showing column 1 to 7 and and all row as `[, 1:7]`. Empty value in row indicates displaying all columns. `1:7` indicates pick all columns between 1 to 7, inclusive.

```{r}
round(table_rr_pa_dia$tab[, 1:7], 2)

# Slightly more fancy display by function called htmlTable, with added gray bars alternating columns
round(table_rr_pa_dia$tab[, 1:7], 2) %>% 
  addHtmlTableStyle(col.columns = c("none", "grey90")) %>% 
  htmlTable()
```
If you like to subset table to simplify, just specify the index (location) of columns or rows, for example to select the outcome count (not incidences i.e., Ps) that is displyed in column 1 and 3, specify column location by `c(1,3)`. We do not use `:` as we do not specify range. 
```{r}
round(table_rr_pa_dia$tab[, c(1,3)], 2)
```
or to get incidence proportions, type 
```{r}
round(table_rr_pa_dia$tab[, c(2,4)], 2)
```
We can also get correct ordering of column and row by reversing index
```{r}
round(table_rr_pa_dia$tab[c(2,1), c(3,1)], 2)
```



### We will now perform bias analysis, starting from selection bias. 
#### Suppose that our hypothetical cohort data (the data are acually survey) are provided by those who agreed to participate and remained in the study until the end, without withdrawal. Therefore, the RR estimates we get might suffer from bias, if selection probabilities of participation into the study and withdrawal are associated with our exposure and outcome status.
IF there is no bias (participation is 100% and no withdrawal) selection probabilities of participating to the study is found to be as follows:    
  - Exposed and Outcome, P_a in the table below= 1  
  - exposed and no Outcome, P_b = 1  
  - Unexposed and Outcome, P_c = 1  
  - unexposed and no Outcome, P_d= 1    

```{r}
# Lines below just creates example tables 
contingencyTable <- data.frame(Outcome_Yes = c("a", "c"), Outcome_No = c("b", "d"))
rownames(contingencyTable) <- c("Exposure_yes", "Exposure_No")
probTable <- data.frame(Outcome_Yes = c("P_a", "P_c"), Outcome_No = c("P_b", "P_d"))
rownames(probTable) <- c("Exposure_yes", "Exposure_No")

contingencyTable %>% 
  addHtmlTableStyle(css.cell = c("width: 140;","width: 140;")) %>% 
  htmlTable(caption = "Table cell labels") 

probTable %>% 
  addHtmlTableStyle(css.cell = c("width: 140;","width: 140;")) %>% 
  htmlTable(caption = "table of selection probabilities") 

```


Here is an example usage of `episensr`'s `selection` bias function.If all selection probabilities are 1.0 (no selection bias), we enter the `bias_params` (selection bias probability parameter) line in the command below as all 1.0,  and  the output look as follows. Note  that `observed` and `selection bias corrected` RR and OR are identical in the output, indicating no bias. The values in the `bias_params` argument should be between 0 and 1. 
**The order of the selection probabilities in the `bias_params` is c(P_a, P_c, P_b, P_d). Also, the output table below has the outcome and exposure swapped (rows and columns transposed, showing the order of `a, c, b, d`)**
For details, try entering `?selection` for help menu. 
```{r}
selection(matrix(c(434, 1094, 4937, 16263), 
                 dimnames = list(c("Diabetes", "No Diabetes"), 
                                 c("Low PA", "moderate/high PA"))
                 , nrow = 2, byrow = TRUE),
          bias_parms  = c(1, 1, 1, 1))
```
#### You need to experiment a couple different values of the selection probabilites in `bias_parms` before working on the questions below, values between 0 and 1.  


# Question 1a
#### Enter the selection probabilites provided below into the `bias_params` line in the episens command  and show the output. You need to copy and paste the `selection` function of episens I wrote above, paste below, and enter the appropriate selection probabilities. THere is no need to edit anything else in the command.  

  - Exposed (low PA) and Outcome (Diabetes) = 0.9
  - Exposed and no Outcome =0.6
  - Unexposed and Outcome = 0.8
  - Unexposed and no Outcome = 0.8
```{r}
#Enter your answer here 
```


# Question 1b 
#### Based on the output you generated, is there selection bias in the original RR?
```{r}
#Enter your answer here 
```

# Question 1c 
#### Another study on the same population found out that the selection probabitlies are actually as follows: 
  - Exposed (low PA) and Outcome (Diabetes) = 0.9
  - Exposed and no Outcome =0.9
  - Unexposed and Outcome = 0.8
  - Unexposed and no Outcome = 0.8
```{r}
#Enter your answer here 
```

#### Run the `selection` command again (paste below) based on these updated probabilities by filling  `bias_parms`. Again, careful with the ordering of these values. 


          
# Question 1d
Based on the output from Question 1c, answer if there is selection bias or not, and if not please explain why in one or two sentences.
```{r}
#Enter your answer here 
```


# Question 2 - Information bias 
#### We will correct missclassificaiton of the exposure, PA variable. 
Suppose that a subsequent validation study using these data show that people inaccurately reports physical activity status, with the following sensitivity and specificity of exposure classification among diabetes cases and non-cases.  

```{r}
# Lines below just creates example tables 
contingencyTable <- data.frame(Outcome_Yes = c("a", "c"), Outcome_No = c("b", "d"))
rownames(contingencyTable) <- c("Exposure_yes", "Exposure_No")

contingencyTable %>% 
  addHtmlTableStyle(css.cell = c("width: 140;","width: 140;")) %>% 
  htmlTable(caption = "Table cell labels") 

```
  - Se_outcome: Sensitivity of exposure classification among outcome (i.e., extent of misclassification from a to c among outcome)  = 0.95 
  - Sp_outcome: Specificity of exposure classification among outcome (i.e., extent of misclassification from c to a among outcome)   =0.8 
  - Se_noOutcome: Sensitivity of exposure classification among no outcome (i.e., extent of misclassification from b to d among no outcome) = 0.95   
  - Sp_noOutcome: Specificity of exposure classification among no outcome (i.e., extent of misclassification from  d to b among no outcome) = 0.8   
  
  
As a practice, we will plug in these classification metrics into the `misclassification` function in `episenser`, when there is no missclassification (i.e., all Se and Sp values are 1.0). The probabilities values entering the `bias_parms` line is *Se_outcome, Se_noOutcome, Sp_outcome, Sp_noOutcome*.   
```{r}
misclassification(matrix(c(434, 1094, 4937, 16263), 
                 dimnames = list(c("Diabetes", "No Diabetes"), 
                                 c("Low PA", "moderate/high PA")), 
                 nrow = 2, byrow = TRUE), 
                 type = "exposure",
          bias_parms  = c(1.0, 1.0, 1.0, 1.0))
```

# Question 2a
#### Now, perform bias sensitivity analysis based on the imperfect classification accuracies provided above (values of sensitivities and specificities), by updating the four values in the `bias_parms` line. Show the output below. 
```{r}
#Enter your answer here 
```


# Question 2b
#### Comparing `Misclassification Bias Corrected Relative Risk` and `Observed Relative Risk` (the latter is the crude - uncorrected association). Is there information bias? 
```{r}
#Enter your answer here 
```

# Question 2c
#### Is this differential or non-differential missclassification? Please provide 1 or 2 sentence of explanation. 
```{r}
#Enter your answer here 
```


# Question 2d
#### 

  - Sensitivity of exposure classification among outcome (i.e., extent of misclassification from a to c among outcome)  = 0.9
  - Specificity of exposure classification among outcome (i.e., extent of misclassification from c to a among outcome)   =0.9 
  - Sensitivity of exposure classification among no outcome (i.e., extent of misclassification from b to d among no outcome) = 0.5   
  - Specificity of exposure classification among no outcome (i.e., extent of misclassification from  d to b among no outcome) = 0.9   


```{r}
#Enter your answer here 
```

# Question 2e
#### Is this differential or non-differential missclassification (results of Question 2d)? Please provide 1 or 2 sentence of explanation. 
```{r}
#Enter your answer here 
```
